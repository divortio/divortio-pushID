<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pushID & sessionManager Test Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .output {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .input:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch {
            height: 1.5rem;
            width: 2.75rem;
            background-color: #d1d5db;
            border-radius: 9999px;
            position: relative;
            transition: background-color 0.2s ease-in-out;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            height: 1.25rem;
            width: 1.25rem;
            left: 0.125rem;
            top: 0.125rem;
            background-color: white;
            border-radius: 9999px;
            transition: transform 0.2s ease-in-out;
        }

        .toggle-checkbox:checked + .toggle-switch {
            background-color: #3b82f6;
        }

        .toggle-checkbox:checked + .toggle-switch::before {
            transform: translateX(1.25rem);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem;
            white-space: normal;
            word-break: break-all;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        th.sort-asc::after {
            content: ' ▲';
        }

        th.sort-desc::after {
            content: ' ▼';
        }

        .decoded-output {
            font-size: 0.8rem;
            color: #4b5563;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }

        .lock-icon {
            cursor: pointer;
            color: #9ca3af;
            flex-shrink: 0;
        }

        .lock-icon:hover {
            color: #374151;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-live {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-expired {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900">pushID & sessionManager</h1>
        <p class="text-lg text-gray-600 mt-2">Interactive Test Application</p>
    </header>

    <main class="flex flex-col gap-12">

        <!-- Hero Section -->
        <section class="card w-full text-center">
            <h2 class="text-xl font-semibold text-gray-700">Your pushID is:</h2>
            <p id="hero-id-output" class="text-2xl font-mono my-4 p-4 bg-gray-50 rounded-lg break-all"></p>
            <div class="flex justify-center flex-wrap gap-4">
                <button id="hero-generate-another" class="btn btn-primary">Generate Another</button>
                <a href="#pushid-tester" class="btn btn-secondary">Customize</a>
                <a href="#session-simulator" class="btn btn-secondary">Try Session Simulator</a>
            </div>
        </section>

        <!-- Decoded Hero Section -->
        <section class="card w-full">
            <h2 class="text-2xl font-bold mb-4">Decoded pushID</h2>
            <div id="decoded-hero-content" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                <!-- Content will be injected by JS -->
            </div>
            <p id="collision-info" class="text-center text-sm text-gray-500 mt-4"></p>
        </section>

        <!-- Global Options Section -->
        <section class="card w-full" id="pushid-tester">
            <h2 class="text-2xl font-bold mb-4">Global Options</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium mb-1">Default Stub (Optional)</label>
                    <input id="global-stub" type="text" class="input" placeholder="(none)">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Default Randomness Length</label>
                    <input id="global-length" type="number" class="input" value="12">
                </div>
                <div class="flex flex-col">
                    <label for="use-current-time" class="toggle-label text-sm font-medium mb-1">
                        Use Current Time
                        <input type="checkbox" id="use-current-time" class="toggle-checkbox" checked>
                        <div class="toggle-switch ml-2"></div>
                    </label>
                    <div id="custom-time-container" class="hidden">
                        <input id="global-time" type="datetime-local" class="input">
                    </div>
                </div>
            </div>
        </section>

        <!-- pushID Tester Section -->
        <div class="w-full">
            <h2 class="text-2xl font-bold mb-4">pushID Library Tester</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Column 1 -->
                <div class="flex flex-col gap-8">
                    <section class="card" data-card-name="newID">
                        <h3 class="text-xl font-semibold">Generate newID (string)</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Stub Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" class="input local-stub" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Provide a stub to create a delimited ID.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Length Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" class="input local-length" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button class="btn btn-primary test-newID">newID()</button>
                        </div>
                        <pre class="output mt-4 flex-grow">Click button to generate.</pre>
                        <div class="decoded-output"></div>
                    </section>

                    <section class="card" data-card-name="newHashID">
                        <h3 class="text-xl font-semibold">Hashing Functions</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Stub Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" class="input local-stub" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Length Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" class="input local-length" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Data to Hash (any text)</label>
                                <textarea class="input local-hash-data"
                                          rows="2">{ "user": "jane", "id": 123 }</textarea>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button class="btn btn-primary test-hash">hash()</button>
                            <button class="btn btn-primary test-newHashID">newHashID()</button>
                        </div>
                        <h4 class="text-md font-semibold mt-4">hash() Output:</h4>
                        <pre class="output mt-2 hash-output">Click hash() to generate.</pre>
                        <h4 class="text-md font-semibold mt-4">newHashID() Output:</h4>
                        <pre class="output mt-2 flex-grow id-output">Click newHashID() to generate.</pre>
                        <div class="decoded-output"></div>
                    </section>
                </div>
                <!-- Column 2 -->
                <div class="flex flex-col gap-8">
                    <section class="card" data-card-name="newObj">
                        <h3 class="text-xl font-semibold">Generate newObj (object)</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Stub Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" class="input local-stub" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Length Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" class="input local-length" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button class="btn btn-primary test-newObj">newObj()</button>
                        </div>
                        <pre class="output mt-4 flex-grow">Click button to generate.</pre>
                        <div class="decoded-output"></div>
                    </section>
                    <section class="card">
                        <h3 class="text-xl font-semibold">Decoding Functions</h3>
                        <div class="space-y-4 mt-2">
                            <label class="block text-sm font-medium mb-1">ID to Decode</label>
                            <input id="decode-id-input" type="text" class="input" placeholder="Paste a pushID here">
                            <button id="test-decode" class="btn btn-primary w-full">Decode ID (tryDecodeID)</button>
                        </div>
                        <pre id="pushid-decode-output" class="output mt-4 flex-grow">Enter an ID and click Decode.</pre>
                    </section>
                </div>
            </div>
        </div>

        <!-- Generated ID History Table -->
        <div class="w-full mt-8">
            <section class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Generated ID History</h2>
                    <div class="flex items-center gap-2">
                        <select id="id-history-limit" class="input w-auto">
                            <option value="5">Last 5</option>
                            <option value="10" selected>Last 10</option>
                            <option value="20">Last 20</option>
                            <option value="50">Last 50</option>
                            <option value="100">Last 100</option>
                        </select>
                        <button id="id-history-clear" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="id-history-table" class="sortable">
                        <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Stub</th>
                            <th>ID</th>
                            <th>Encoded Time</th>
                            <th>Randomness</th>
                            <th>Length</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="6" class="text-center text-gray-500">No IDs generated yet.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>


        <!-- sessionManager Sections -->
        <div class="w-full mt-8" id="session-simulator">
            <!-- Session Debugger -->
            <section class="card mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Session Debugger</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Client ID (cID)</label>
                        <input id="debug-cid" type="text" class="input" placeholder="Paste cID">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Session ID (sID)</label>
                        <input id="debug-sid" type="text" class="input" placeholder="Paste sID">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Event ID (eID)</label>
                        <input id="debug-eid" type="text" class="input" placeholder="Paste eID">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Sequence ID (seqID)</label>
                        <input id="debug-seqid" type="text" class="input" placeholder="e.g., 1-1">
                    </div>
                </div>
                <div id="debugger-state-card" class="card bg-gray-50 mt-4">
                    <p class="text-center text-gray-500">Enter IDs to see their state.</p>
                </div>
                <button id="debugger-simulate" class="btn btn-primary mt-4">Simulate This State</button>
            </section>

            <section class="card">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Session Simulator</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Session Timeout</label>
                        <div class="flex gap-2">
                            <input id="session-timeout-value" type="number" class="input" value="30">
                            <select id="session-timeout-unit" class="input">
                                <option value="seconds">Seconds</option>
                                <option value="minutes" selected>Minutes</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-end">
                        <label for="session-use-stubs" class="toggle-label text-sm font-medium">
                            Add Stubs to Session IDs
                            <input type="checkbox" id="session-use-stubs" class="toggle-checkbox">
                            <div class="toggle-switch ml-2"></div>
                        </label>
                    </div>
                </div>

                <h3 class="text-xl font-semibold my-4">Live Session State</h3>
                <div id="live-state-card" class="card bg-gray-50">
                    <p class="text-center text-gray-500">Processing first event...</p>
                </div>

                <h3 class="text-xl font-semibold my-4">Live Storage State</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-semibold mb-2">Cookies</h4>
                        <div class="overflow-x-auto">
                            <table id="session-cookies-table" class="sortable">
                                <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td colspan="2" class="text-center text-gray-500">No cookies found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">LocalStorage</h4>
                        <div class="overflow-x-auto">
                            <table id="session-localstorage-table" class="sortable">
                                <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td colspan="2" class="text-center text-gray-500">No items found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center my-4">
                    <h3 class="text-xl font-semibold">Event History</h3>
                    <div class="flex items-center gap-2">
                        <select id="session-history-limit" class="input w-auto">
                            <option value="5">Last 5</option>
                            <option value="10" selected>Last 10</option>
                            <option value="20">Last 20</option>
                            <option value="50">Last 50</option>
                            <option value="100">Last 100</option>
                        </select>
                        <button id="session-history-clear" class="btn btn-secondary">Clear History</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="session-history-table" class="sortable">
                        <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>seqID</th>
                            <th>cID</th>
                            <th>sID</th>
                            <th>eID</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-gray-500">No events tracked yet.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
</div>


<!-- Application Logic -->
<script>
    export {sessionManager, pushID} from './sessionManager.js'

    document.addEventListener('DOMContentLoaded', () => {
        let manager;
        let idHistory = [];
        let sessionEventHistory = [];
        let liveStateInterval;
        let decodedHeroInterval;

        const lockIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock-fill" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>`;
        const unlockIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-unlock-fill" viewBox="0 0 16 16"><path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/></svg>`;

        // --- UI Element References ---
        const heroIdOutput = document.getElementById('hero-id-output');
        const decodedHeroContent = document.getElementById('decoded-hero-content');
        const globalStubInput = document.getElementById('global-stub');
        const globalLengthInput = document.getElementById('global-length');
        const globalTimeInput = document.getElementById('global-time');
        const useCurrentTimeToggle = document.getElementById('use-current-time');
        const customTimeContainer = document.getElementById('custom-time-container');
        const decodeIdInput = document.getElementById('decode-id-input');
        const decodeOutput = document.getElementById('pushid-decode-output');
        const idHistoryTableBody = document.querySelector('#id-history-table tbody');
        const idHistoryLimit = document.getElementById('id-history-limit');

        const liveStateCard = document.getElementById('live-state-card');
        const sessionCookiesTableBody = document.querySelector('#session-cookies-table tbody');
        const sessionStorageTableBody = document.querySelector('#session-localstorage-table tbody');
        const sessionHistoryTableBody = document.querySelector('#session-history-table tbody');
        const sessionHistoryLimit = document.getElementById('session-history-limit');
        const debuggerStateCard = document.getElementById('debugger-state-card');

        // --- Table Sorting Logic ---
        const getCellValue = (tr, idx) => {
            const cell = tr.children[idx];
            const sortVal = cell.dataset.sortValue;
            return sortVal !== undefined ? sortVal : (cell.innerText || cell.textContent);
        };
        const comparer = (idx, asc) => (a, b) => ((v1, v2) =>
                v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
        )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

        document.querySelectorAll('.sortable th').forEach(th => th.addEventListener('click', (() => {
            const table = th.closest('table');
            const tbody = table.querySelector('tbody');
            Array.from(tbody.querySelectorAll('tr'))
                .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
                .forEach(tr => tbody.appendChild(tr));
            table.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            th.classList.toggle('sort-asc', this.asc);
            th.classList.toggle('sort-desc', !this.asc);
        })));


        // --- Global Options Logic ---
        useCurrentTimeToggle.addEventListener('change', () => {
            customTimeContainer.style.display = useCurrentTimeToggle.checked ? 'none' : 'block';
        });

        function syncGlobalToLocal() {
            const globalStub = globalStubInput.value;
            const globalLength = globalLengthInput.value;
            document.querySelectorAll('.card[data-card-name]').forEach(card => {
                const localStub = card.querySelector('.local-stub');
                const localLength = card.querySelector('.local-length');
                if (localStub && localStub.disabled) localStub.value = globalStub;
                if (localLength && localLength.disabled) localLength.value = globalLength;
            });
        }

        [globalStubInput, globalLengthInput].forEach(input => input.addEventListener('input', syncGlobalToLocal));


        function getGlobalOptions() {
            const options = {};
            const stub = globalStubInput.value.trim();
            if (stub) options.stub = stub; else options.stub = null;
            const length = parseInt(globalLengthInput.value, 10);
            if (!isNaN(length)) options.length = length;
            if (!useCurrentTimeToggle.checked) {
                const timeValue = globalTimeInput.value;
                if (timeValue) options.time = new Date(timeValue).getTime();
            }
            return options;
        }

        // --- pushID Test Logic ---
        function getLocalOptions(card) {
            const globalOptions = getGlobalOptions();
            const localStubInput = card.querySelector('.local-stub');
            const localLengthInput = card.querySelector('.local-length');

            const options = {...globalOptions};
            if (localStubInput && !localStubInput.disabled) {
                const localStubValue = localStubInput.value.trim();
                options.stub = localStubValue === '' ? null : localStubValue;
            }

            if (localLengthInput && !localLengthInput.disabled) {
                const localLength = parseInt(localLengthInput.value, 10);
                if (!isNaN(localLength)) options.length = localLength;
            }

            return options;
        }

        function triggerDecode(id) {
            decodeIdInput.value = id;
            document.getElementById('test-decode').click();
        }

        function updateDecodedOutput(card, id) {
            try {
                const decoded = pushID.tryDecodeID(id);
                const container = card.querySelector('.decoded-output');
                if (!decoded) {
                    container.innerHTML = '<strong>Invalid ID</strong>';
                    return;
                }
                container.innerHTML = `
                        <strong>Time:</strong> ${formatDate(decoded.date)}<br>
                        <strong>Randomness:</strong> ${decoded.randomness}<br>
                        <strong>Stub:</strong> ${decoded.stub || '(none)'}
                    `;
            } catch (e) { /* ignore invalid ids */
            }
        }

        function updateIdHistory(id) {
            const decoded = pushID.tryDecodeID(id);
            if (!decoded) return;
            idHistory.unshift({
                id: decoded.id,
                timestamp: decoded.date,
                encodedTime: decoded.encodedTime,
                randomness: decoded.randomness,
                length: decoded.id.length,
                stub: decoded.stub
            });
            renderIdHistoryTable();
        }

        function formatDate(dateObj) {
            return dateObj.toISOString();
        }

        function renderIdHistoryTable() {
            const limit = parseInt(idHistoryLimit.value, 10);
            const history = idHistory.slice(0, limit);
            if (history.length === 0) {
                idHistoryTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No IDs generated yet.</td></tr>';
                return;
            }
            idHistoryTableBody.innerHTML = history.map(item => `
                    <tr>
                        <td data-sort-value="${item.timestamp.getTime()}">${formatDate(item.timestamp)}</td>
                        <td>${item.stub || '(legacy)'}</td>
                        <td>${item.id}</td>
                        <td>${item.encodedTime}</td>
                        <td>${item.randomness}</td>
                        <td>${item.length}</td>
                    </tr>
                `).join('');
        }

        document.querySelectorAll('.lock-icon').forEach(icon => {
            const input = icon.closest('.flex').querySelector('.input');
            icon.innerHTML = input.disabled ? lockIconSVG : unlockIconSVG;
            icon.addEventListener('click', () => {
                input.disabled = !input.disabled;
                icon.innerHTML = input.disabled ? lockIconSVG : unlockIconSVG;
                if (input.disabled) {
                    syncGlobalToLocal();
                }
            });
        });

        document.querySelectorAll('.test-newID').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                const result = pushID.newID(options);
                card.querySelector('.output').textContent = result;
                updateDecodedOutput(card, result);
                triggerDecode(result);
                updateIdHistory(result);
            });
        });

        document.querySelectorAll('.test-newObj').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                const result = pushID.newObj(options);
                card.querySelector('.output').textContent = JSON.stringify(result, null, 2);
                updateDecodedOutput(card, result.id);
                triggerDecode(result.id);
                updateIdHistory(result.id);
            });
        });

        document.querySelectorAll('.test-hash').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                let data;
                try {
                    data = JSON.parse(card.querySelector('.local-hash-data').value);
                } catch (e) {
                    data = card.querySelector('.local-hash-data').value;
                }
                const result = pushID.hash(data, options.length);
                card.querySelector('.hash-output').textContent = result;
                card.querySelector('.id-output').textContent = 'N/A';
                card.querySelector('.decoded-output').innerHTML = '';
            });
        });

        document.querySelectorAll('.test-newHashID').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                let data;
                try {
                    data = JSON.parse(card.querySelector('.local-hash-data').value);
                } catch (e) {
                    data = card.querySelector('.local-hash-data').value;
                }
                options.data = data;
                const result = pushID.newHashID(options);
                card.querySelector('.id-output').textContent = result;
                updateDecodedOutput(card, result);
                triggerDecode(result);
                updateIdHistory(result);
            });
        });

        document.getElementById('test-decode').addEventListener('click', () => {
            const id = decodeIdInput.value.trim();
            if (!id) {
                decodeOutput.textContent = 'Please enter an ID to decode.';
                return;
            }
            const result = pushID.tryDecodeID(id);
            if (result) {
                decodeOutput.textContent = JSON.stringify(result, null, 2);
            } else {
                decodeOutput.textContent = `Error: Invalid pushID format.`;
            }
        });

        document.getElementById('id-history-clear').addEventListener('click', () => {
            idHistory = [];
            renderIdHistoryTable();
        });
        idHistoryLimit.addEventListener('change', renderIdHistoryTable);


        // --- sessionManager Test Logic ---
        function initializeManager() {
            const timeoutValue = parseInt(document.getElementById('session-timeout-value').value, 10) || 30;
            const timeoutUnit = document.getElementById('session-timeout-unit').value;
            const sessionTimeout = timeoutUnit === 'seconds' ? timeoutValue * 1000 : timeoutValue * 60 * 1000;
            const useStubs = document.getElementById('session-use-stubs').checked;
            manager = sessionManager({sessionTimeout, useStubs});
        }

        function updateStorageDisplay() {
            if (!manager) return;
            const prefix = manager.config.cookiePrefix;

            const cookies = document.cookie.split(';').filter(c => c.trim().startsWith(prefix));
            if (cookies.length > 0) {
                sessionCookiesTableBody.innerHTML = cookies.map(c => {
                    const [key, value] = c.trim().split('=');
                    return `<tr><td>${key}</td><td>${decodeURIComponent(value)}</td></tr>`;
                }).join('');
            } else {
                sessionCookiesTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500">(none)</td></tr>';
            }

            let lsItems = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    const item = JSON.parse(localStorage.getItem(key));
                    lsItems.push(`<tr><td>${key}</td><td>${item.value}</td></tr>`);
                }
            }
            sessionStorageTableBody.innerHTML = lsItems.length > 0 ? lsItems.join('') : '<tr><td colspan="2" class="text-center text-gray-500">(none)</td></tr>';
        }

        function renderSessionHistoryTable() {
            const limit = parseInt(sessionHistoryLimit.value, 10);
            const history = sessionEventHistory.slice(0, limit);
            if (history.length === 0) {
                sessionHistoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No events tracked yet.</td></tr>';
                return;
            }
            sessionHistoryTableBody.innerHTML = history.map(event => {
                const eIDDecoded = pushID.decodeID(event.eID);
                return `
                    <tr>
                        <td data-sort-value="${eIDDecoded.date.getTime()}">${formatDate(eIDDecoded.date)}</td>
                        <td>${event.seqID}</td>
                        <td>${event.cID}</td>
                        <td>${event.sID}</td>
                        <td>${event.eID}</td>
                    </tr>
                `
            }).join('');
        }

        function updateLiveStateDisplay(state, isManualUpdate = false) {
            clearInterval(liveStateInterval);
            const lastActivityTime = (state.eID && pushID.decodeTime(state.eID)) || (state.sID && pushID.decodeTime(state.sID)) || (state.cID && pushID.decodeTime(state.cID));

            const render = () => {
                const now = Date.now();
                const timeRemaining = manager.config.sessionTimeout - (now - lastActivityTime);
                const isExpired = timeRemaining <= 0;
                const countdown = isExpired ? '00:00' : `${String(Math.floor(timeRemaining / 60000)).padStart(2, '0')}:${String(Math.floor((timeRemaining % 60000) / 1000)).padStart(2, '0')}`;

                liveStateCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="font-semibold">Current State</h4>
                            <div class="flex items-center gap-4">
                                <div>
                                    <span class="status-badge ${isExpired ? 'status-expired' : 'status-live'}">${isExpired ? 'Expired' : 'Live'}</span>
                                    <span class="ml-2 text-sm font-mono">${countdown}</span>
                                </div>
                                <button id="session-clear-storage" class="btn btn-secondary btn-sm">Clear Storage</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                            ${createLiveStateField('cID', state.cID, now, 'New Client', 'session-new-client', 'btn-secondary')}
                            ${createLiveStateField('sID', state.sID, now, 'New Session', 'session-new', 'btn-primary')}
                            ${createLiveStateField('eID', state.eID, now, 'Track Event', 'session-event', 'btn-primary')}
                             <div class="flex flex-col items-center">
                                <p class="text-sm font-medium text-gray-500">seqID</p>
                                <p class="text-2xl font-mono mt-2">${state.seqID}</p>
                            </div>
                        </div>
                    `;

                // Re-attach listeners
                liveStateCard.querySelector('#session-new-client').addEventListener('click', handleNewClient);
                liveStateCard.querySelector('#session-new').addEventListener('click', () => processEvent(true));
                liveStateCard.querySelector('#session-event').addEventListener('click', () => processEvent(false));
                liveStateCard.querySelector('#session-clear-storage').addEventListener('click', () => {
                    if (!manager) initializeManager();
                    manager.clear();
                    updateStorageDisplay();
                });
            };
            render();
            if (!isManualUpdate) {
                liveStateInterval = setInterval(render, 1000);
            }
        }

        function createLiveStateField(key, id, now, buttonText, buttonId, buttonClass) {
            const decodedTime = pushID.decodeTime(id);
            return `
                    <div class="flex flex-col items-center">
                        <p class="text-sm font-medium text-gray-500">${key}</p>
                        <p class="text-xs font-mono break-all mt-1">${id}</p>
                        <p class="text-xs text-gray-600 mt-1">${formatDate(new Date(decodedTime))}</p>
                        <p class="text-sm font-semibold mt-1">${Math.floor((now - decodedTime) / 1000)}s ago</p>
                        <button id="${buttonId}" class="btn ${buttonClass} mt-4 w-full">${buttonText}</button>
                    </div>
                `;
        }

        function processEvent(isNewSession = false) {
            initializeManager();
            if (isNewSession) {
                manager.storageHandler.set('sID', '', {expires: new Date(0)});
                manager.storageHandler.set('eID', '', {expires: new Date(0)});
            }
            const result = manager.process();
            sessionEventHistory.unshift(result.newState);
            updateIdHistory(result.newState.eID);
            renderSessionHistoryTable();
            updateStorageDisplay();
            updateLiveStateDisplay(result.newState);
        }

        document.querySelectorAll('#session-timeout-value, #session-timeout-unit, #session-use-stubs').forEach(el => {
            el.addEventListener('change', () => {
                if (sessionEventHistory.length > 0) {
                    initializeManager();
                    updateLiveStateDisplay(sessionEventHistory[0]);
                }
            });
        });

        function handleNewClient() {
            if (!manager) initializeManager();
            manager.clear();
            updateStorageDisplay();
            processEvent(true);
        }

        document.getElementById('session-history-clear').addEventListener('click', () => {
            sessionEventHistory = [];
            renderSessionHistoryTable();
        });
        sessionHistoryLimit.addEventListener('change', renderSessionHistoryTable);

        // --- Debugger Logic ---
        function updateDebuggerState() {
            const cID = document.getElementById('debug-cid').value.trim();
            const sID = document.getElementById('debug-sid').value.trim();
            const eID = document.getElementById('debug-eid').value.trim();
            const seqID = document.getElementById('debug-seqid').value.trim();

            if (!cID && !sID && !eID && !seqID) {
                debuggerStateCard.innerHTML = '<p class="text-center text-gray-500">Enter IDs to see their state.</p>';
                return;
            }

            let content = '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">';
            [{id: cID, name: 'cID'}, {id: sID, name: 'sID'}, {id: eID, name: 'eID'}, {
                id: seqID,
                name: 'seqID'
            }].forEach(({id, name}) => {
                content += '<div>';
                content += `<p class="text-sm font-medium text-gray-500">${name}</p>`;
                if (id) {
                    try {
                        if (name !== 'seqID') {
                            const decoded = pushID.decodeID(id);
                            const elapsed = Math.floor((Date.now() - decoded.date.getTime()) / 1000);
                            content += `<p class="text-xs font-mono break-all">${id}</p>`;
                            content += `<p class="text-xs text-gray-600 mt-1">${formatDate(decoded.date)}</p>`;
                            content += `<p class="text-sm font-semibold mt-1">${elapsed}s ago</p>`;
                        } else {
                            content += `<p class="text-2xl font-mono mt-2">${id}</p>`;
                        }
                    } catch (e) {
                        content += `<p class="text-xs text-red-500">Invalid ID</p>`;
                    }
                } else {
                    content += `<p class="text-xs text-gray-400">(empty)</p>`;
                }
                content += '</div>';
            });
            content += '</div>';
            debuggerStateCard.innerHTML = content;
        }

        ['debug-cid', 'debug-sid', 'debug-eid', 'debug-seqid'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateDebuggerState);
        });

        document.getElementById('debugger-simulate').addEventListener('click', () => {
            updateDebuggerState();
            if (!manager) initializeManager();
            manager.clear();

            const cID = document.getElementById('debug-cid').value.trim();
            const sID = document.getElementById('debug-sid').value.trim();
            const eID = document.getElementById('debug-eid').value.trim();
            const seqID = document.getElementById('debug-seqid').value.trim();

            if (eID) updateIdHistory(eID);

            const newState = {cID, sID, eID, seqID};

            if (cID) manager.storageHandler.set('cID', cID, {expires: new Date(new Date().setFullYear(new Date().getFullYear() + 2))});
            if (sID) manager.storageHandler.set('sID', sID, {expires: new Date(Date.now() + manager.config.sessionTimeout)});
            if (eID) manager.storageHandler.set('eID', eID, {expires: new Date(Date.now() + manager.config.sessionTimeout)});
            if (seqID) manager.storageHandler.set('seqID', seqID, {expires: new Date(Date.now() + manager.config.sessionTimeout)});

            sessionEventHistory.unshift(newState);
            renderSessionHistoryTable();
            updateStorageDisplay();
            updateLiveStateDisplay(newState, true);

            document.getElementById('session-simulator').scrollIntoView();
        });


        // --- Hero Logic ---
        function updateDecodedHero(id) {
            clearInterval(decodedHeroInterval);
            try {
                const decoded = pushID.decodeID(id);
                const render = () => {
                    const now = Date.now();
                    const combinations = (BigInt(64) ** BigInt(decoded.randomness.length));
                    const formatted = formatLargeNumber(combinations);
                    const probability = `1 in ${formatted.short}`;

                    decodedHeroContent.innerHTML = `
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Encoded Time</p>
                                <p class="text-lg font-mono break-all">${decoded.encodedTime}</p>
                                <p class="text-xs text-gray-600 mt-1">${formatDate(decoded.date)}</p>
                                <p class="text-sm font-semibold mt-1">${Math.floor((now - decoded.date.getTime()) / 1000)}s ago</p>
                                <button id="regenerate-time" class="btn btn-primary mt-4 w-full">Regenerate Time</button>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Randomness</p>
                                <p class="text-lg font-mono break-all">${decoded.randomness}</p>
                                <p class="text-xs text-gray-600 mt-1">Length: ${decoded.randomness.length} (${decoded.randomness.length * 6} bits of entropy)</p>
                                <p class="text-sm font-semibold mt-1">${probability}</p>
                                <button id="regenerate-randomness" class="btn btn-primary mt-4 w-full">Regenerate Randomness</button>
                                <p class="text-xs text-gray-500 mt-2">i.e., 1 in ${formatted.full} (${formatted.name})</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Stub</p>
                                <p class="text-lg font-mono break-all">${decoded.stub || '(none)'}</p>
                            </div>
                        `;

                    document.getElementById('regenerate-time').addEventListener('click', () => {
                        const currentDecoded = pushID.decodeID(heroIdOutput.textContent);
                        const newId = pushID.newID({
                            randomness: currentDecoded.randomness,
                            stub: currentDecoded.stub
                        });
                        heroIdOutput.textContent = newId;
                        updateDecodedHero(newId);
                        updateIdHistory(newId);
                    });

                    document.getElementById('regenerate-randomness').addEventListener('click', () => {
                        const currentDecoded = pushID.decodeID(heroIdOutput.textContent);
                        const newId = pushID.newID({
                            time: currentDecoded.date.getTime(),
                            stub: currentDecoded.stub
                        });
                        heroIdOutput.textContent = newId;
                        updateDecodedHero(newId);
                        updateIdHistory(newId);
                    });
                };
                render();
                decodedHeroInterval = setInterval(render, 1000);
            } catch (e) {
                decodedHeroContent.innerHTML = `<p class="text-center text-red-500 col-span-3">Could not decode ID: ${e.message}</p>`;
            }
        }

        function formatLargeNumber(bigInt) {
            const s = bigInt.toString();
            if (s.length <= 3) return {short: s, full: s, name: ''};
            const suffixes = ['', 'thousand', 'million', 'billion', 'trillion', 'quadrillion', 'quintillion', 'sextillion', 'septillion'];
            const i = Math.floor((s.length - 1) / 3);
            let v = s.slice(0, -i * 3);
            if (s.length % 3 !== 1) {
                v = v.slice(0, 1) + '.' + v.slice(1);
            }
            const short = `${v.slice(0, 4)} ${suffixes[i]}`;
            const full = bigInt.toLocaleString('en-US');
            return {short, full, name: suffixes[i]};
        }

        function generateHeroID() {
            const id = pushID.newID();
            heroIdOutput.textContent = id;
            updateIdHistory(id);
            updateDecodedHero(id);

            const cID = pushID.newID({stub: 'cID'});
            const sID = pushID.newID({stub: 'sID'});
            const eID = pushID.newID({stub: 'eID'});

            // Pre-populate debugger
            document.getElementById('debug-cid').value = cID;
            document.getElementById('debug-sid').value = sID;
            document.getElementById('debug-eid').value = eID;
            document.getElementById('debug-seqid').value = '1-1';
            updateDebuggerState();
        }

        document.getElementById('hero-generate-another').addEventListener('click', generateHeroID);

        // --- Initial state ---
        syncGlobalToLocal();
        initializeManager();
        updateStorageDisplay();
        renderIdHistoryTable();
        generateHeroID();
        processEvent(true);
    });
</script>
</body>
</html>
