<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pushID & sessionManager Test Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .output {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .input:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch {
            height: 1.5rem;
            width: 2.75rem;
            background-color: #d1d5db;
            border-radius: 9999px;
            position: relative;
            transition: background-color 0.2s ease-in-out;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            height: 1.25rem;
            width: 1.25rem;
            left: 0.125rem;
            top: 0.125rem;
            background-color: white;
            border-radius: 9999px;
            transition: transform 0.2s ease-in-out;
        }

        .toggle-checkbox:checked + .toggle-switch {
            background-color: #3b82f6;
        }

        .toggle-checkbox:checked + .toggle-switch::before {
            transform: translateX(1.25rem);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem;
            white-space: normal;
            word-break: break-all;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        th.sort-asc::after {
            content: ' ▲';
        }

        th.sort-desc::after {
            content: ' ▼';
        }

        .decoded-output {
            font-size: 0.8rem;
            color: #4b5563;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }

        .lock-icon {
            cursor: pointer;
            color: #9ca3af;
            flex-shrink: 0;
        }

        .lock-icon:hover {
            color: #374151;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-live {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-expired {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900">pushID & sessionManager</h1>
        <p class="text-lg text-gray-600 mt-2">Interactive Test Application</p>
    </header>

    <main class="flex flex-col gap-12">

        <!-- Hero Section -->
        <section class="card w-full text-center">
            <h2 class="text-xl font-semibold text-gray-700">Your pushID is:</h2>
            <p id="hero-id-output" class="text-2xl font-mono my-4 p-4 bg-gray-50 rounded-lg break-all"></p>
            <div class="flex justify-center flex-wrap gap-4">
                <button id="hero-generate-another" class="btn btn-primary">Generate Another</button>
                <a href="#pushid-tester" class="btn btn-secondary">Customize</a>
                <a href="#session-simulator" class="btn btn-secondary">Try Session Simulator</a>
            </div>
        </section>

        <!-- Decoded Hero Section -->
        <section class="card w-full">
            <h2 class="text-2xl font-bold mb-4">Decoded pushID</h2>
            <div id="decoded-hero-content" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                <!-- Content will be injected by JS -->
            </div>
            <p id="collision-info" class="text-center text-sm text-gray-500 mt-4"></p>
        </section>

        <!-- Global Options Section -->
        <section class="card w-full" id="pushid-tester">
            <h2 class="text-2xl font-bold mb-4">Global Options</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium mb-1">Default Stub</label>
                    <input id="global-stub" type="text" class="input" value="pshID">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Default Randomness Length</label>
                    <input id="global-length" type="number" class="input" value="12">
                </div>
                <div class="flex flex-col">
                    <label for="use-current-time" class="toggle-label text-sm font-medium mb-1">
                        Use Current Time
                        <input type="checkbox" id="use-current-time" class="toggle-checkbox" checked>
                        <div class="toggle-switch ml-2"></div>
                    </label>
                    <div id="custom-time-container" class="hidden">
                        <input id="global-time" type="datetime-local" class="input">
                    </div>
                </div>
            </div>
        </section>

        <!-- pushID Tester Section -->
        <div class="w-full">
            <h2 class="text-2xl font-bold mb-4">pushID Library Tester</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Column 1 -->
                <div class="flex flex-col gap-8">
                    <section class="card" data-card-name="newID">
                        <h3 class="text-xl font-semibold">Generate newID (string)</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Stub Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" class="input local-stub" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Leave empty to generate a legacy ID.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Length Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" class="input local-length" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button class="btn btn-primary test-newID">newID()</button>
                        </div>
                        <pre class="output mt-4 flex-grow">Click button to generate.</pre>
                        <div class="decoded-output"></div>
                    </section>

                    <section class="card" data-card-name="newHashID">
                        <h3 class="text-xl font-semibold">Hashing Functions</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Stub Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" class="input local-stub" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Length Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" class="input local-length" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Data to Hash (JSON)</label>
                                <textarea class="input local-hash-data"
                                          rows="2">{ "user": "jane", "id": 123 }</textarea>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button class="btn btn-primary test-hash">hash()</button>
                            <button class="btn btn-primary test-newHashID">newHashID()</button>
                        </div>
                        <h4 class="text-md font-semibold mt-4">hash() Output:</h4>
                        <pre class="output mt-2 hash-output">Click hash() to generate.</pre>
                        <h4 class="text-md font-semibold mt-4">newHashID() Output:</h4>
                        <pre class="output mt-2 flex-grow id-output">Click newHashID() to generate.</pre>
                        <div class="decoded-output"></div>
                    </section>
                </div>
                <!-- Column 2 -->
                <div class="flex flex-col gap-8">
                    <section class="card" data-card-name="newObj">
                        <h3 class="text-xl font-semibold">Generate newObj (object)</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Stub Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" class="input local-stub" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Local Length Override</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" class="input local-length" placeholder="Inherits from Global"
                                           disabled>
                                    <span class="lock-icon"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-4">
                            <button class="btn btn-primary test-newObj">newObj()</button>
                        </div>
                        <pre class="output mt-4 flex-grow">Click button to generate.</pre>
                        <div class="decoded-output"></div>
                    </section>
                    <section class="card">
                        <h3 class="text-xl font-semibold">Decoding Functions</h3>
                        <div class="space-y-4 mt-2">
                            <label class="block text-sm font-medium mb-1">ID to Decode</label>
                            <input id="decode-id-input" type="text" class="input" placeholder="Paste a pushID here">
                            <button id="test-decode" class="btn btn-primary w-full">Decode ID</button>
                        </div>
                        <pre id="pushid-decode-output" class="output mt-4 flex-grow">Enter an ID and click Decode.</pre>
                    </section>
                </div>
            </div>
        </div>

        <!-- Generated ID History Table -->
        <div class="w-full mt-8">
            <section class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Generated ID History</h2>
                    <div class="flex items-center gap-2">
                        <select id="id-history-limit" class="input w-auto">
                            <option value="5">Last 5</option>
                            <option value="10" selected>Last 10</option>
                            <option value="20">Last 20</option>
                            <option value="50">Last 50</option>
                            <option value="100">Last 100</option>
                        </select>
                        <button id="id-history-clear" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="id-history-table" class="sortable">
                        <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Stub</th>
                            <th>ID</th>
                            <th>Encoded Time</th>
                            <th>Randomness</th>
                            <th>Length</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="6" class="text-center text-gray-500">No IDs generated yet.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>


        <!-- sessionManager Sections -->
        <div class="w-full mt-8" id="session-simulator">
            <!-- Session Debugger -->
            <section class="card mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Session Debugger</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Client ID (cID)</label>
                        <input id="debug-cid" type="text" class="input" placeholder="Paste cID">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Session ID (sID)</label>
                        <input id="debug-sid" type="text" class="input" placeholder="Paste sID">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Event ID (eID)</label>
                        <input id="debug-eid" type="text" class="input" placeholder="Paste eID">
                    </div>
                </div>
                <div id="debugger-state-card" class="card bg-gray-50 mt-4">
                    <p class="text-center text-gray-500">Enter IDs to see their state.</p>
                </div>
                <button id="debugger-simulate" class="btn btn-primary mt-4">Simulate This State</button>
            </section>

            <section class="card">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Session Simulator</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Session Timeout</label>
                        <div class="flex gap-2">
                            <input id="session-timeout-value" type="number" class="input" value="30">
                            <select id="session-timeout-unit" class="input">
                                <option value="seconds">Seconds</option>
                                <option value="minutes" selected>Minutes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h3 class="text-xl font-semibold my-4">Live Session State</h3>
                <div id="live-state-card" class="card bg-gray-50">
                    <p class="text-center text-gray-500">Processing first event...</p>
                </div>

                <h3 class="text-xl font-semibold my-4">Live Storage State</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-semibold mb-2">Cookies</h4>
                        <div class="overflow-x-auto">
                            <table id="session-cookies-table" class="sortable">
                                <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td colspan="2" class="text-center text-gray-500">No cookies found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">LocalStorage</h4>
                        <div class="overflow-x-auto">
                            <table id="session-localstorage-table" class="sortable">
                                <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td colspan="2" class="text-center text-gray-500">No items found.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center my-4">
                    <h3 class="text-xl font-semibold">Event History</h3>
                    <div class="flex items-center gap-2">
                        <select id="session-history-limit" class="input w-auto">
                            <option value="5">Last 5</option>
                            <option value="10" selected>Last 10</option>
                            <option value="20">Last 20</option>
                            <option value="50">Last 50</option>
                            <option value="100">Last 100</option>
                        </select>
                        <button id="session-history-clear" class="btn btn-secondary">Clear History</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="session-history-table" class="sortable">
                        <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Stub</th>
                            <th>cID</th>
                            <th>sID</th>
                            <th>eID</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-gray-500">No events tracked yet.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>
</div>

<!-- Library Code -->
<script>
    /**
     * ===================================================================
     * pushID Library (v3.5.0)
     * ===================================================================
     */
    const pushID = (function () {
        const PUSH_CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz~';
        const CHARS_MAP = {};
        for (let i = 0; i < PUSH_CHARS.length; i++) CHARS_MAP[PUSH_CHARS[i]] = i;
        let lastIdObj = null;

        function _generateObject(options = {}) {
            const {time, stub = 'pshID', length = 12} = options;
            const randLength = Math.max(12, length);
            let now;
            if (time instanceof Date) now = time.getTime();
            else if (typeof time === 'number') now = time;
            else now = Date.now();
            const timeChars = new Array(8);
            let timestampNow = now;
            for (let i = 7; i >= 0; i--) {
                timeChars[i] = PUSH_CHARS.charAt(timestampNow % 64);
                timestampNow = Math.floor(timestampNow / 64);
            }
            const timeStr = timeChars.join('');
            let randStr;
            if (typeof options.randomness === 'string') randStr = options.randomness;
            else if (options.data !== undefined) randStr = publicApi.hash(options.data, randLength);
            else randStr = publicApi.newRnd(randLength);
            const useDelimitedFormat = stub && typeof stub === 'string';
            const newObj = {
                id: useDelimitedFormat ? `${timeStr}-${stub}-${randStr}` : `${timeStr}${randStr}`,
                randomness: randStr,
                date: new Date(now),
                stub: useDelimitedFormat ? stub : null
            };
            lastIdObj = newObj;
            return newObj;
        }

        function _serialize(val) {
            if (val === null || val === undefined) return 'null';
            if (typeof val !== 'object') return JSON.stringify(val);
            if (Array.isArray(val)) return '[' + val.map(_serialize).join(',') + ']';
            return '{' + Object.keys(val).sort().map(key => JSON.stringify(key) + ':' + _serialize(val[key])).join(',') + '}';
        }

        function decodeObj(id) {
            if (typeof id !== 'string' || id.length === 0) throw new TypeError('Invalid Push ID provided.');
            const parts = id.split('-');
            if (parts.length === 3) {
                const [timeStr, stub, randStr] = parts;
                const timestamp = decodeTime(timeStr);
                return {id, randomness: randStr, date: new Date(timestamp), stub, encodedTime: timeStr};
            } else {
                if (id.length < 8) throw new Error('Invalid legacy Push ID format.');
                const timeStr = id.substring(0, 8);
                const randStr = id.substring(8);
                const timestamp = decodeTime(timeStr);
                return {id, randomness: randStr, date: new Date(timestamp), stub: null, encodedTime: timeStr};
            }
        }

        function decodeTime(timeStr) {
            let timestamp = 0;
            for (let i = 0; i < timeStr.length; i++) {
                const charValue = CHARS_MAP[timeStr[i]];
                if (charValue === undefined) throw new Error('Invalid Push ID character: ' + timeStr[i]);
                timestamp = timestamp * 64 + charValue;
            }
            return timestamp;
        }

        const publicApi = {
            newID: (options) => _generateObject(options).id, newObj: (options) => _generateObject(options),
            previousID: () => lastIdObj ? lastIdObj.id : null, previousObj: () => lastIdObj,
            newTime: () => Date.now(), newDate: () => new Date(),
            newRnd: (length = 12) => {
                const len = Math.max(12, length);
                const chars = new Array(len);
                for (let i = 0; i < len; i++) chars[i] = PUSH_CHARS.charAt(Math.floor(Math.random() * 64));
                return chars.join('');
            },
            hash: (input, length = 12) => {
                const len = Math.max(12, length);
                const serialized = _serialize(input);
                let h1 = 1779033703, h2 = 3144134277, h3 = 1013904242, h4 = 2773480762;
                for (let i = 0, k; i < serialized.length; i++) {
                    k = serialized.charCodeAt(i);
                    h1 = h2 ^ Math.imul(h1, 597399067);
                    h2 = h3 ^ Math.imul(h2, 2869860233);
                    h3 = h4 ^ Math.imul(h3, 951274213);
                    h4 = h1 ^ Math.imul(h4, 2716044179);
                    h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
                    h2 = Math.imul(h2 ^ (h2 >>> 13), 3266489909);
                    h3 = Math.imul(h3 ^ (h3 >>> 16), 2246822507);
                    h4 = Math.imul(h4 ^ (h4 >>> 13), 3266489909);
                    h1 = (h1 ^ k) >>> 0;
                }
                const hashChars = new Array(len);
                for (let i = 0; i < len; i++) {
                    const state = [h1, h2, h3, h4];
                    const charIndex = (state[i % 4] >> ((i % 5) * 3)) & 63;
                    hashChars[i] = PUSH_CHARS.charAt(charIndex);
                }
                return hashChars.join('');
            },
            newHashID: (options = {}) => publicApi.newID(options),
            decodeID: (id) => decodeObj(id), decodeTime: (id) => decodeObj(id).date.getTime(),
            decodeDate: (id) => decodeObj(id).date, decodeStr: (id) => decodeObj(id).randomness,
            decodeStub: (id) => decodeObj(id).stub,
        };
        publicApi.next = publicApi.newID;
        publicApi.nextID = publicApi.newID;
        publicApi.nextObj = publicApi.newObj;
        publicApi.previous = publicApi.previousID;
        publicApi.prevObj = publicApi.previousObj;
        publicApi.nextHashID = publicApi.newHashID;
        publicApi.prevHashID = publicApi.previousID;
        return publicApi;
    })();

    /**
     * ===================================================================
     * sessionManager Library (v4.4.0 with API improvements)
     * ===================================================================
     */
    /**
     * ===================================================================
     * sessionManager Library (v4.4.0 with API improvements)
     * ===================================================================
     */
    const sessionManager = (config = {}) => {
        const finalConfig = {
            sessionTimeout: 30 * 60 * 1000, randomnessLength: 12, cookiePrefix: '__psh_',
            cookieOptions: {path: '/', secure: false, sameSite: 'Lax'}, ...config,
        };

        const storageHandler = {
            _isCookieEnabled: null,
            _checkCookieEnabled() {
                if (this._isCookieEnabled !== null) return this._isCookieEnabled;
                try {
                    document.cookie = "testcookie=1; SameSite=Lax";
                    const enabled = document.cookie.indexOf("testcookie") !== -1;
                    document.cookie = "testcookie=1; expires=Thu, 01-Jan-1970 00:00:01 GMT; SameSite=Lax";
                    this._isCookieEnabled = enabled;
                    return enabled;
                } catch (e) {
                    this._isCookieEnabled = false;
                    return false;
                }
            },
            get(key) {
                const name = finalConfig.cookiePrefix + key;
                if (this._checkCookieEnabled()) {
                    const match = document.cookie.match(new RegExp('(^|;\\s*)' + name + '=([^;]+)'));
                    return match ? decodeURIComponent(match[2]) : null;
                } else if (typeof localStorage !== 'undefined') {
                    const item = localStorage.getItem(name);
                    if (!item) return null;
                    try {
                        const {value, expires} = JSON.parse(item);
                        if (expires && Date.now() > expires) {
                            localStorage.removeItem(name);
                            return null;
                        }
                        return value;
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            },
            set(key, value, cookieOpts) {
                const name = finalConfig.cookiePrefix + key;
                if (this._checkCookieEnabled()) {
                    let cookieString = `${name}=${encodeURIComponent(value)}`;
                    for (const optKey in cookieOpts) {
                        const optValue = cookieOpts[optKey];
                        if (optValue instanceof Date) cookieString += `; ${optKey}=${optValue.toUTCString()}`;
                        else cookieString += `; ${optKey}=${optValue}`;
                    }
                    document.cookie = cookieString;
                } else if (typeof localStorage !== 'undefined') {
                    const expires = cookieOpts.expires ? new Date(cookieOpts.expires).getTime() : null;
                    localStorage.setItem(name, JSON.stringify({value, expires}));
                }
            },
            clear() {
                const keys = ['cID', 'sID', 'eID'];
                keys.forEach(key => {
                    const name = finalConfig.cookiePrefix + key;
                    if (this._checkCookieEnabled()) {
                        document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
                    }
                    if (typeof localStorage !== 'undefined') {
                        localStorage.removeItem(name);
                    }
                });
            }
        };

        const process = (options = {}) => {
            const cID = storageHandler.get('cID');
            const sID = storageHandler.get('sID');
            const prevEID = storageHandler.get('eID');

            const oldState = {
                cID: cID, sID: sID, eID: prevEID,
                clientTime: cID ? new Date(pushID.decodeTime(cID)) : null,
                sessionTime: sID ? new Date(pushID.decodeTime(sID)) : null,
                eventTime: prevEID ? new Date(pushID.decodeTime(prevEID)) : null
            };

            let isSessionExpired = true;
            const lastActivityID = prevEID || sID || cID;
            if (lastActivityID) {
                try {
                    const lastActivityTime = pushID.decodeTime(lastActivityID);
                    isSessionExpired = (Date.now() - lastActivityTime) > finalConfig.sessionTimeout;
                } catch (e) {
                    isSessionExpired = true;
                }
            }

            const idOptions = {length: finalConfig.randomnessLength};
            const newEID = pushID.newID({...idOptions, stub: 'eID'});

            const finalCID = cID || pushID.newID({...idOptions, stub: 'cID'});
            const finalSID = (!sID || isSessionExpired) ? pushID.newID({...idOptions, stub: 'sID'}) : sID;

            const newState = {
                cID: finalCID, sID: finalSID, eID: newEID,
                clientTime: new Date(pushID.decodeTime(finalCID)),
                sessionTime: new Date(pushID.decodeTime(finalSID)),
                eventTime: new Date(pushID.decodeTime(newEID))
            };

            const changes = {
                isNewClient: !cID,
                isNewSession: !sID || isSessionExpired
            };

            const cIDExpiry = new Date();
            cIDExpiry.setFullYear(cIDExpiry.getFullYear() + 2);
            storageHandler.set('cID', newState.cID, {...finalConfig.cookieOptions, expires: cIDExpiry});
            const sessionExpiry = new Date(Date.now() + finalConfig.sessionTimeout);
            const sessionCookieOptions = {...finalConfig.cookieOptions, expires: sessionExpiry};
            storageHandler.set('sID', newState.sID, sessionCookieOptions);
            storageHandler.set('eID', newState.eID, sessionCookieOptions);

            return {...newState, newState, oldState, changes};
        };

        return {process, clear: storageHandler.clear.bind(storageHandler), storageHandler, config: finalConfig};
    };
</script>

<!-- Application Logic -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let manager;
        let idHistory = [];
        let sessionEventHistory = [];
        let liveStateInterval;
        let decodedHeroInterval;

        const lockIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock-fill" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg>`;
        const unlockIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-unlock-fill" viewBox="0 0 16 16"><path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/></svg>`;

        // --- UI Element References ---
        const heroIdOutput = document.getElementById('hero-id-output');
        const decodedHeroContent = document.getElementById('decoded-hero-content');
        const globalStubInput = document.getElementById('global-stub');
        const globalLengthInput = document.getElementById('global-length');
        const globalTimeInput = document.getElementById('global-time');
        const useCurrentTimeToggle = document.getElementById('use-current-time');
        const customTimeContainer = document.getElementById('custom-time-container');
        const decodeIdInput = document.getElementById('decode-id-input');
        const decodeOutput = document.getElementById('pushid-decode-output');
        const idHistoryTableBody = document.querySelector('#id-history-table tbody');
        const idHistoryLimit = document.getElementById('id-history-limit');

        const liveStateCard = document.getElementById('live-state-card');
        const sessionCookiesTableBody = document.querySelector('#session-cookies-table tbody');
        const sessionStorageTableBody = document.querySelector('#session-localstorage-table tbody');
        const sessionHistoryTableBody = document.querySelector('#session-history-table tbody');
        const sessionHistoryLimit = document.getElementById('session-history-limit');
        const debuggerStateCard = document.getElementById('debugger-state-card');

        // --- Table Sorting Logic ---
        const getCellValue = (tr, idx) => {
            const cell = tr.children[idx];
            const sortVal = cell.dataset.sortValue;
            return sortVal !== undefined ? sortVal : (cell.innerText || cell.textContent);
        };
        const comparer = (idx, asc) => (a, b) => ((v1, v2) =>
                v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
        )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

        document.querySelectorAll('.sortable th').forEach(th => th.addEventListener('click', (() => {
            const table = th.closest('table');
            const tbody = table.querySelector('tbody');
            Array.from(tbody.querySelectorAll('tr'))
                .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
                .forEach(tr => tbody.appendChild(tr));
            table.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            th.classList.toggle('sort-asc', this.asc);
            th.classList.toggle('sort-desc', !this.asc);
        })));


        // --- Global Options Logic ---
        useCurrentTimeToggle.addEventListener('change', () => {
            customTimeContainer.style.display = useCurrentTimeToggle.checked ? 'none' : 'block';
        });

        function syncGlobalToLocal() {
            const globalStub = globalStubInput.value;
            const globalLength = globalLengthInput.value;
            document.querySelectorAll('.card[data-card-name]').forEach(card => {
                const localStub = card.querySelector('.local-stub');
                const localLength = card.querySelector('.local-length');
                if (localStub && localStub.disabled) localStub.value = globalStub;
                if (localLength && localLength.disabled) localLength.value = globalLength;
            });
        }

        [globalStubInput, globalLengthInput].forEach(input => input.addEventListener('input', syncGlobalToLocal));


        function getGlobalOptions() {
            const options = {};
            const stub = globalStubInput.value.trim();
            if (stub) options.stub = stub;
            const length = parseInt(globalLengthInput.value, 10);
            if (!isNaN(length)) options.length = length;
            if (!useCurrentTimeToggle.checked) {
                const timeValue = globalTimeInput.value;
                if (timeValue) options.time = new Date(timeValue).getTime();
            }
            return options;
        }

        // --- pushID Test Logic ---
        function getLocalOptions(card) {
            const globalOptions = getGlobalOptions();
            const localStubInput = card.querySelector('.local-stub');
            const localLengthInput = card.querySelector('.local-length');

            const options = {...globalOptions};
            if (localStubInput && !localStubInput.disabled) {
                const localStubValue = localStubInput.value.trim();
                options.stub = localStubValue === '' ? null : localStubValue;
            }

            if (localLengthInput && !localLengthInput.disabled) {
                const localLength = parseInt(localLengthInput.value, 10);
                if (!isNaN(localLength)) options.length = localLength;
            }

            return options;
        }

        function triggerDecode(id) {
            decodeIdInput.value = id;
            document.getElementById('test-decode').click();
        }

        function updateDecodedOutput(card, id) {
            try {
                const decoded = pushID.decodeID(id);
                const container = card.querySelector('.decoded-output');
                container.innerHTML = `
                        <strong>Time:</strong> ${formatDate(decoded.date)}<br>
                        <strong>Randomness:</strong> ${decoded.randomness}<br>
                        <strong>Stub:</strong> ${decoded.stub || '(none)'}
                    `;
            } catch (e) { /* ignore invalid ids */
            }
        }

        function updateIdHistory(id) {
            const decoded = pushID.decodeID(id);
            idHistory.unshift({
                id: decoded.id,
                timestamp: decoded.date,
                encodedTime: decoded.encodedTime,
                randomness: decoded.randomness,
                length: decoded.id.length,
                stub: decoded.stub
            });
            renderIdHistoryTable();
        }

        function formatDate(dateObj) {
            return dateObj.toISOString();
        }

        function renderIdHistoryTable() {
            const limit = parseInt(idHistoryLimit.value, 10);
            const history = idHistory.slice(0, limit);
            if (history.length === 0) {
                idHistoryTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No IDs generated yet.</td></tr>';
                return;
            }
            idHistoryTableBody.innerHTML = history.map(item => `
                    <tr>
                        <td data-sort-value="${item.timestamp.getTime()}">${formatDate(item.timestamp)}</td>
                        <td>${item.stub || '(legacy)'}</td>
                        <td>${item.id}</td>
                        <td>${item.encodedTime}</td>
                        <td>${item.randomness}</td>
                        <td>${item.length}</td>
                    </tr>
                `).join('');
        }

        document.querySelectorAll('.lock-icon').forEach(icon => {
            const input = icon.closest('.flex').querySelector('.input');
            icon.innerHTML = input.disabled ? lockIconSVG : unlockIconSVG;
            icon.addEventListener('click', () => {
                input.disabled = !input.disabled;
                icon.innerHTML = input.disabled ? lockIconSVG : unlockIconSVG;
                if (input.disabled) {
                    syncGlobalToLocal();
                }
            });
        });

        document.querySelectorAll('.test-newID').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                const result = pushID.newID(options);
                card.querySelector('.output').textContent = result;
                updateDecodedOutput(card, result);
                triggerDecode(result);
                updateIdHistory(result);
            });
        });

        document.querySelectorAll('.test-newObj').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                const result = pushID.newObj(options);
                card.querySelector('.output').textContent = JSON.stringify(result, null, 2);
                updateDecodedOutput(card, result.id);
                triggerDecode(result.id);
                updateIdHistory(result.id);
            });
        });

        document.querySelectorAll('.test-hash').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                try {
                    const data = JSON.parse(card.querySelector('.local-hash-data').value);
                    const result = pushID.hash(data, options.length);
                    card.querySelector('.hash-output').textContent = result;
                    card.querySelector('.id-output').textContent = 'N/A';
                    card.querySelector('.decoded-output').innerHTML = '';
                } catch (e) {
                    card.querySelector('.hash-output').textContent = `Error: ${e.message}`;
                }
            });
        });

        document.querySelectorAll('.test-newHashID').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('.card');
                const options = getLocalOptions(card);
                try {
                    const data = JSON.parse(card.querySelector('.local-hash-data').value);
                    options.data = data;
                    const result = pushID.newHashID(options);
                    card.querySelector('.id-output').textContent = result;
                    updateDecodedOutput(card, result);
                    triggerDecode(result);
                    updateIdHistory(result);
                } catch (e) {
                    card.querySelector('.id-output').textContent = `Error: ${e.message}`;
                }
            });
        });

        document.getElementById('test-decode').addEventListener('click', () => {
            const id = decodeIdInput.value.trim();
            if (!id) {
                decodeOutput.textContent = 'Please enter an ID to decode.';
                return;
            }
            try {
                const result = pushID.decodeID(id);
                decodeOutput.textContent = JSON.stringify(result, null, 2);
            } catch (e) {
                decodeOutput.textContent = `Error: ${e.message}`;
            }
        });

        document.getElementById('id-history-clear').addEventListener('click', () => {
            idHistory = [];
            renderIdHistoryTable();
        });
        idHistoryLimit.addEventListener('change', renderIdHistoryTable);


        // --- sessionManager Test Logic ---
        function initializeManager() {
            const timeoutValue = parseInt(document.getElementById('session-timeout-value').value, 10) || 30;
            const timeoutUnit = document.getElementById('session-timeout-unit').value;
            const sessionTimeout = timeoutUnit === 'seconds' ? timeoutValue * 1000 : timeoutValue * 60 * 1000;
            manager = sessionManager({sessionTimeout});
        }

        function updateStorageDisplay() {
            if (!manager) return;
            const prefix = manager.config.cookiePrefix;

            const cookies = document.cookie.split(';').filter(c => c.trim().startsWith(prefix));
            if (cookies.length > 0) {
                sessionCookiesTableBody.innerHTML = cookies.map(c => {
                    const [key, value] = c.trim().split('=');
                    return `<tr><td>${key}</td><td>${decodeURIComponent(value)}</td></tr>`;
                }).join('');
            } else {
                sessionCookiesTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500">(none)</td></tr>';
            }

            let lsItems = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    const item = JSON.parse(localStorage.getItem(key));
                    lsItems.push(`<tr><td>${key}</td><td>${item.value}</td></tr>`);
                }
            }
            sessionStorageTableBody.innerHTML = lsItems.length > 0 ? lsItems.join('') : '<tr><td colspan="2" class="text-center text-gray-500">(none)</td></tr>';
        }

        function renderSessionHistoryTable() {
            const limit = parseInt(sessionHistoryLimit.value, 10);
            const history = sessionEventHistory.slice(0, limit);
            if (history.length === 0) {
                sessionHistoryTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No events tracked yet.</td></tr>';
                return;
            }
            sessionHistoryTableBody.innerHTML = history.map(event => {
                const eIDDecoded = pushID.decodeID(event.eID);
                return `
                    <tr>
                        <td data-sort-value="${eIDDecoded.date.getTime()}">${formatDate(eIDDecoded.date)}</td>
                        <td>${eIDDecoded.stub}</td>
                        <td>${event.cID}</td>
                        <td>${event.sID}</td>
                        <td>${event.eID}</td>
                    </tr>
                `
            }).join('');
        }

        function updateLiveStateDisplay(state, isManualUpdate = false) {
            clearInterval(liveStateInterval);
            const lastActivityTime = pushID.decodeTime(state.eID || state.sID || state.cID);

            const render = () => {
                const now = Date.now();
                const timeRemaining = manager.config.sessionTimeout - (now - lastActivityTime);
                const isExpired = timeRemaining <= 0;
                const countdown = isExpired ? '00:00' : `${String(Math.floor(timeRemaining / 60000)).padStart(2, '0')}:${String(Math.floor((timeRemaining % 60000) / 1000)).padStart(2, '0')}`;

                liveStateCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="font-semibold">Current State</h4>
                            <div class="flex items-center gap-4">
                                <div>
                                    <span class="status-badge ${isExpired ? 'status-expired' : 'status-live'}">${isExpired ? 'Expired' : 'Live'}</span>
                                    <span class="ml-2 text-sm font-mono">${countdown}</span>
                                </div>
                                <button id="session-clear-storage" class="btn btn-secondary btn-sm">Clear Storage</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            ${createLiveStateField('cID', state.cID, now, 'New Client', 'session-new-client', 'btn-secondary')}
                            ${createLiveStateField('sID', state.sID, now, 'New Session', 'session-new', 'btn-primary')}
                            ${createLiveStateField('eID', state.eID, now, 'Track Event', 'session-event', 'btn-primary')}
                        </div>
                    `;

                // Re-attach listeners for the new editable fields
                liveStateCard.querySelectorAll('.lock-icon').forEach(icon => {
                    const input = icon.closest('.flex').querySelector('.input');
                    icon.innerHTML = input.disabled ? lockIconSVG : unlockIconSVG;
                    icon.addEventListener('click', () => {
                        input.disabled = !input.disabled;
                        icon.innerHTML = input.disabled ? lockIconSVG : unlockIconSVG;
                    });
                });
                liveStateCard.querySelectorAll('.live-state-input').forEach(input => {
                    const key = input.dataset.key;
                    const handler = (e) => {
                        if (e.type === 'keydown' && e.key !== 'Enter') return;
                        e.target.disabled = true;
                        e.target.closest('.flex').querySelector('.lock-icon').innerHTML = lockIconSVG;
                        manualStateUpdate(key, e.target.value);
                    };
                    input.addEventListener('blur', handler);
                    input.addEventListener('keydown', handler);
                });
                // Re-attach control listeners
                liveStateCard.querySelector('#session-new-client').addEventListener('click', handleNewClient);
                liveStateCard.querySelector('#session-new').addEventListener('click', () => processEvent(true));
                liveStateCard.querySelector('#session-event').addEventListener('click', () => processEvent(false));
                liveStateCard.querySelector('#session-clear-storage').addEventListener('click', () => {
                    if (!manager) initializeManager();
                    manager.clear();
                    updateStorageDisplay();
                });
            };
            render();
            if (!isManualUpdate) {
                liveStateInterval = setInterval(render, 1000);
            }
        }

        function createLiveStateField(key, id, now, buttonText, buttonId, buttonClass) {
            const decodedTime = pushID.decodeTime(id);
            return `
                    <div class="flex flex-col items-center">
                        <p class="text-sm font-medium text-gray-500">${key}</p>
                        <div class="flex items-center gap-2 mt-1 w-full">
                            <input type="text" class="input text-xs font-mono live-state-input" value="${id}" data-key="${key}" disabled>
                            <span class="lock-icon"></span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">${formatDate(new Date(decodedTime))}</p>
                        <p class="text-sm font-semibold mt-1">${Math.floor((now - decodedTime) / 1000)}s ago</p>
                        <button id="${buttonId}" class="btn ${buttonClass} mt-4 w-full">${buttonText}</button>
                    </div>
                `;
        }

        function manualStateUpdate(key, value) {
            if (!manager) initializeManager();

            const cIDExpiry = new Date();
            cIDExpiry.setFullYear(cIDExpiry.getFullYear() + 2);
            const sessionExpiry = new Date(Date.now() + manager.config.sessionTimeout);

            const options = key === 'cID' ? {expires: cIDExpiry} : {expires: sessionExpiry};
            manager.storageHandler.set(key, value, {...manager.config.cookieOptions, ...options});

            const newState = {
                cID: manager.storageHandler.get('cID'),
                sID: manager.storageHandler.get('sID'),
                eID: manager.storageHandler.get('eID')
            };

            sessionEventHistory[0] = newState; // Update history head
            renderSessionHistoryTable();
            updateStorageDisplay();
            updateLiveStateDisplay(newState, true); // Update display without starting timer
        }

        function processEvent(isNewSession = false) {
            initializeManager();
            if (isNewSession) {
                manager.storageHandler.set('sID', '', {expires: new Date(0)});
                manager.storageHandler.set('eID', '', {expires: new Date(0)});
            }
            const result = manager.process();
            sessionEventHistory.unshift(result.newState);
            updateIdHistory(result.newState.eID); // Add new eID to the other history
            renderSessionHistoryTable();
            updateStorageDisplay();
            updateLiveStateDisplay(result.newState);
        }

        document.querySelectorAll('#session-timeout-value, #session-timeout-unit').forEach(el => {
            el.addEventListener('change', () => {
                if (sessionEventHistory.length > 0) {
                    initializeManager();
                    updateLiveStateDisplay(sessionEventHistory[0]);
                }
            });
        });

        function handleNewClient() {
            if (!manager) initializeManager();
            manager.clear();
            // Don't clear history: sessionEventHistory = [];
            updateStorageDisplay();
            processEvent(true);
        }

        document.getElementById('session-history-clear').addEventListener('click', () => {
            sessionEventHistory = [];
            renderSessionHistoryTable();
        });
        sessionHistoryLimit.addEventListener('change', renderSessionHistoryTable);

        // --- Debugger Logic ---
        function updateDebuggerState() {
            const cID = document.getElementById('debug-cid').value.trim();
            const sID = document.getElementById('debug-sid').value.trim();
            const eID = document.getElementById('debug-eid').value.trim();

            if (!cID && !sID && !eID) {
                debuggerStateCard.innerHTML = '<p class="text-center text-gray-500">Enter IDs to see their state.</p>';
                return;
            }

            let content = '<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">';
            [{id: cID, name: 'cID'}, {id: sID, name: 'sID'}, {id: eID, name: 'eID'}].forEach(({id, name}) => {
                content += '<div>';
                content += `<p class="text-sm font-medium text-gray-500">${name}</p>`;
                if (id) {
                    try {
                        const decoded = pushID.decodeID(id);
                        const elapsed = Math.floor((Date.now() - decoded.date.getTime()) / 1000);
                        content += `<p class="text-xs font-mono break-all">${id}</p>`;
                        content += `<p class="text-xs text-gray-600 mt-1">${formatDate(decoded.date)}</p>`;
                        content += `<p class="text-sm font-semibold mt-1">${elapsed}s ago</p>`;
                    } catch (e) {
                        content += `<p class="text-xs text-red-500">Invalid ID</p>`;
                    }
                } else {
                    content += `<p class="text-xs text-gray-400">(empty)</p>`;
                }
                content += '</div>';
            });
            content += '</div>';
            debuggerStateCard.innerHTML = content;
        }

        ['debug-cid', 'debug-sid', 'debug-eid'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateDebuggerState);
        });

        document.getElementById('debugger-simulate').addEventListener('click', () => {
            updateDebuggerState(); // Refresh "ago" time on click
            if (!manager) initializeManager();
            manager.clear();

            const cID = document.getElementById('debug-cid').value.trim();
            const sID = document.getElementById('debug-sid').value.trim();
            const eID = document.getElementById('debug-eid').value.trim();

            if (eID) updateIdHistory(eID); // Add simulated eID to history

            const newState = {cID, sID, eID};

            if (cID) manager.storageHandler.set('cID', cID, {expires: new Date(new Date().setFullYear(new Date().getFullYear() + 2))});
            if (sID) manager.storageHandler.set('sID', sID, {expires: new Date(Date.now() + manager.config.sessionTimeout)});
            if (eID) manager.storageHandler.set('eID', eID, {expires: new Date(Date.now() + manager.config.sessionTimeout)});

            sessionEventHistory.unshift(newState);
            renderSessionHistoryTable();
            updateStorageDisplay();
            updateLiveStateDisplay(newState, true); // Manual update, don't start live timer

            document.getElementById('session-simulator').scrollIntoView();
        });


        // --- Hero Logic ---
        function updateDecodedHero(id) {
            clearInterval(decodedHeroInterval);
            try {
                const decoded = pushID.decodeID(id);
                const render = () => {
                    const now = Date.now();
                    const combinations = (BigInt(64) ** BigInt(decoded.randomness.length));
                    const probability = `1 in ${formatLargeNumber(combinations)}`;

                    decodedHeroContent.innerHTML = `
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Encoded Time</p>
                                <p class="text-lg font-mono break-all">${decoded.encodedTime}</p>
                                <p class="text-xs text-gray-600 mt-1">${formatDate(decoded.date)}</p>
                                <p class="text-sm font-semibold mt-1">${Math.floor((now - decoded.date.getTime()) / 1000)}s ago</p>
                                <button id="regenerate-time" class="btn btn-primary mt-4 w-full">Regenerate Time</button>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Randomness</p>
                                <p class="text-lg font-mono break-all">${decoded.randomness}</p>
                                <p class="text-xs text-gray-600 mt-1">Length: ${decoded.randomness.length} (${decoded.randomness.length * 6} bits of entropy)</p>
                                <p class="text-sm font-semibold mt-1">${probability}</p>
                                <button id="regenerate-randomness" class="btn btn-primary mt-4 w-full">Regenerate Randomness</button>
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium text-gray-500">Stub</p>
                                <p class="text-lg font-mono break-all">${decoded.stub || '(none)'}</p>
                            </div>
                        `;
                    document.getElementById('collision-info').textContent = `The chance of a random collision is approximately ${probability} for each millisecond of time.`;

                    document.getElementById('regenerate-time').addEventListener('click', () => {
                        const currentDecoded = pushID.decodeID(heroIdOutput.textContent);
                        const newId = pushID.newID({
                            randomness: currentDecoded.randomness,
                            stub: currentDecoded.stub
                        });
                        heroIdOutput.textContent = newId;
                        updateDecodedHero(newId);
                        updateIdHistory(newId);
                    });

                    document.getElementById('regenerate-randomness').addEventListener('click', () => {
                        const currentDecoded = pushID.decodeID(heroIdOutput.textContent);
                        const newId = pushID.newID({
                            time: currentDecoded.date.getTime(),
                            stub: currentDecoded.stub
                        });
                        heroIdOutput.textContent = newId;
                        updateDecodedHero(newId);
                        updateIdHistory(newId);
                    });
                };
                render();
                decodedHeroInterval = setInterval(render, 1000);
            } catch (e) {
                decodedHeroContent.innerHTML = `<p class="text-center text-red-500 col-span-3">Could not decode ID: ${e.message}</p>`;
            }
        }

        function formatLargeNumber(bigInt) {
            const s = bigInt.toString();
            if (s.length <= 3) return s;
            const suffixes = ['', 'thousand', 'million', 'billion', 'trillion', 'quadrillion', 'quintillion', 'sextillion', 'septillion'];
            const i = Math.floor((s.length - 1) / 3);
            let v = s.slice(0, -i * 3);
            if (s.length % 3 !== 1) {
                v = v.slice(0, 1) + '.' + v.slice(1);
            }
            return `${v.slice(0, 4)} ${suffixes[i]}`;
        }

        function generateHeroID() {
            const id = pushID.newID();
            heroIdOutput.textContent = id;
            updateIdHistory(id);
            updateDecodedHero(id);

            const cID = pushID.newID({stub: 'cID'});
            const sID = pushID.newID({stub: 'sID'});
            const eID = pushID.newID({stub: 'eID'});

            // Pre-populate debugger
            document.getElementById('debug-cid').value = cID;
            document.getElementById('debug-sid').value = sID;
            document.getElementById('debug-eid').value = eID;
            updateDebuggerState();
        }

        document.getElementById('hero-generate-another').addEventListener('click', generateHeroID);

        // --- Initial state ---
        syncGlobalToLocal();
        initializeManager();
        updateStorageDisplay();
        renderIdHistoryTable();
        generateHeroID();
        processEvent(true);
    });
</script>
</body>
</html>
